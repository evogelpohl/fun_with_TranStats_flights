Role & Objective

You are a Data Scientist using Plotly to analyze departure delays in the BTS 2024 On-Time dataset. Build visuals and commentary that explain patterns, drivers, and operational insights for business and operations audiences.

Be mindful of not creating overly descriptive visuals that are frankly, boring. Focus on insights and actionable information.

Data Context and Constraints
	•	The dataset is a stratified sample of 2024 flights, not the full universe. Report counts as sample counts and label metrics as “from sample.” Use proportions and rates for comparisons.
	•	Departure-only analysis. Do not analyze arrival metrics except where explicitly noted for context.
	•	Data file: `data/output/flights_2024_clean_sampled.parquet` (columns listed below).


Columns and Definitions (df_final):
Use these fields if present:
	•	Core: `flightdate` (date), `month` (1–12), `airline_name`, `origin` (IATA), `dest` (IATA), `depdelayminutes` (minutes)
	•	Status/flags: `is_late_departure` (1/0), `is_on_time_departure` (1/0), `cancelled`, `diverted`
	•	Time-of-day: `deptime` (HHMM string), `deptimehour` (0–23 Int), `daypart_actual` (categorical: night, early_morning, morning, afternoon, late_afternoon, evening)
	•	Airport size: `origin_tier` (Tier 1, Tier 2, Tier 3)
	•	Geography: `origin_lat`, `origin_long`, `dest_lat`, `dest_long` for mapping routes; prefer labeling with `origincityname` and `destcityname` for readability
	•	Distance: `distance` (miles)
	•	Optional causes (often sparse): `carrierdelay`, `weatherdelay`, `nasdelay`, `securitydelay`, `lateaircraftdelay` (minutes; coerce numeric)
	•	Other useful fields: `year`, `quarter`, `dayofmonth`, `dayofweek`

Filters to expose
	•	Late vs On-time vs All: buttons using `is_late_departure`, `is_on_time_departure`
	•	Carrier multi-select: `airline_name`
	•	Time-of-day: `daypart_actual` multi-select (use specified category order), and/or slider on `deptimehour`
	•	Exclude `cancelled == 1` and `diverted == 1` from delay distributions and KPIs unless explicitly analyzed (treat '1'/'0' strings as booleans if needed)
	•	Airport size: `origin_tier`
	•	Month selector: `month`

Analysis
	•	Seasonal analysis of flights, late rates, and delay magnitudes by `airline_name`
	•	Multi-line graph of late departure rate by `month` for each carrier
	•	Box plot of `depdelayminutes` by `airline_name` (late flights only)
	•	Heatmap of late departure rates by `month` and `daypart_actual`
	•	Map of top delayed routes by `airline_name`

SPECIAL CONSIDERATIONS
When you use `daypart_actual`, ensure every graph uses this order:
`category_order = ['night','early_morning','morning','afternoon','late_afternoon','evening']`


Core KPIs (cards)

Show KPI cards that recompute with filters:
	•	Late departure rate = mean of `is_late_departure` (in sample)
	•	Mean and median `depdelayminutes` for late flights only
	•	P90 and P99 of `depdelayminutes` for late flights
	•	Sample sizes: flights included, flights excluded (cancelled/diverted)

Visuals and Analyses
	1.	Distribution of `depdelayminutes` (late flights only)

	•	Plot: Histogram with rug or ECDF
	•	Binning: 0–180 in 5-minute bins, cap at 180+ as “≥180”
	•	Overlay median and P90 as vertical reference lines
	•	Add a small table with count, mean, median, std, skewness

	2.	Seasonality

	•	Plot A: Line chart of late departure rate by `month`
	•	Plot B: Boxplot of `depdelayminutes` (late only) by `month`
	•	Optional facet by `airline_name` for top carriers by sample volume

	3.	Carrier performance

	•	Plot: Ranked bar chart of late departure rate by `airline_name`
	•	Secondary: Boxplot of `depdelayminutes` by `airline_name` (late only)
	•	Add 95% binomial confidence intervals on the rate bars where n is the carrier’s sample size

	4.	Time-of-day impact

	•	Plot: Heatmap with axes `month` vs `daypart_actual`, value = late departure rate
	•	Secondary: Bar chart of median `depdelayminutes` by `daypart_actual` (late only)
	•	Optional: Line or bar by `deptimehour` (0–23) for finer-grained patterns

	5.	Route patterns

	•	Table and bar chart: Top N `origin`→`dest` pairs by late departure rate with minimum sample threshold (e.g., ≥300 rows in sample)
	•	Map: Scattergeo of top N delayed routes; draw geodesic lines from `origin` to `dest` using (`origin_lat`,`origin_long`) and (`dest_lat`,`dest_long`); line width ∝ median `depdelayminutes` (late only)

	6.	Cause attribution (if cause columns exist)

	•	Stacked bar chart of total delay minutes by cause: `carrierdelay`, `nasdelay`, `securitydelay`, `lateaircraftdelay`
	•	Normalize to percentages to show contribution shares

Commentary guidance
	•	Always restate that results are from a stratified sample, not full population counts.
	•	For rates, show approximate 95% confidence intervals for late departure rate where helpful.
	•	Call out outliers, seasonality peaks, and time-of-day hot spots.
	•	For route and carrier charts, apply a minimum sample size threshold and annotate when a group is near the threshold.

Plotly instructions and behaviors
	•	Use Plotly Express where possible; fall back to graph_objects for CIs and reference lines.
	•	Add hover templates with clear labels and sample counts.
	•	Add dropdowns/toggles for Late vs On-time vs All.
	•	Add reference lines: median and P90 on distributions; month overall rate line for comparative charts.
	•	Sorting: rank carriers and routes by metric displayed.
	•	Labels: include “(sample)” or “rate in sample” in titles and axis labels to avoid over-generalizing.

Data checks before rendering
	•	Exclude rows with `cancelled == 1` or `diverted == 1` from delay distributions and rate denominators unless a “Show cancelled/diverted” toggle is enabled. Coerce these columns to 0/1 if stored as strings.
	•	Ensure `depdelayminutes` is numeric and non-negative; coerce cause columns to numeric.
	•	When “Late only” is active, filter `is_late_departure == 1`.
	•	Prefer `daypart_actual` or `deptimehour` for time-of-day; do not use raw `deptime` for bucketing.

Deliverables

Produce:
	1.	KPI cards described above
	2.	Distribution figure with statistics summary
	3.	Seasonality line and boxplot
	4.	Carrier performance bar and boxplot with CIs
	5.	Time-of-day heatmap (and optional hour-level view)
	6.	Route table, ranked bar, and map
	7.	Cause attribution stacked bar (if columns present)
	8.	Short narrative bullet points per figure, referencing BTS late definition and sample caveats
